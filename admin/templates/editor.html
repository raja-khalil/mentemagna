{% extends 'admin_base.html' %}

{% block title %}
  {% if editing %}Editar Post{% else %}Novo Post{% endif %} ‚Äî Admin
{% endblock %}

{% block content %}
<h2>{% if editing %}Editar Artigo{% else %}Novo Artigo{% endif %}</h2>

<form method="POST" enctype="multipart/form-data" id="postForm">
    {{ form.hidden_tag() }}

    <div class="mb-3">
        {{ form.titulo.label(class="form-label") }}
        {{ form.titulo(class="form-control") }}
        {% if form.titulo.errors %}
            <div class="text-danger">
                {% for error in form.titulo.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Barra de Ferramentas Multim√≠dia -->
    <div class="mb-3">
        <label class="form-label">{{ form.conteudo.label.text }}</label>
        
        <!-- Toolbar -->
        <div class="editor-toolbar bg-light p-2 rounded-top border">
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('h2')" title="T√≠tulo">
                    üìù H2
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('h3')" title="Subt√≠tulo">
                    üìù H3
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('p')" title="Par√°grafo">
                    üìÑ P
                </button>
            </div>
            
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('strong')" title="Negrito (Ctrl+B)">
                    <strong>B</strong>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('em')" title="It√°lico (Ctrl+I)">
                    <em>I</em>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('u')" title="Sublinhado">
                    <u>U</u>
                </button>
            </div>
            
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertLink()" title="Inserir Link">
                    üîó Link
                </button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="showImageUpload()" title="Inserir Imagem">
                    üì∑ Imagem
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="insertVideo()" title="Inserir V√≠deo">
                    üé• V√≠deo
                </button>
            </div>
            
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('ul')" title="Lista">
                    üìã Lista
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertHR()" title="Linha">
                    ‚ûñ HR
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertBreak()" title="Quebra">
                    ‚èé BR
                </button>
            </div>
        </div>

        <!-- √Årea do Editor -->
        {{ form.conteudo(class="form-control", style="height: 400px; border-top: none; border-top-left-radius: 0; border-top-right-radius: 0;", id="conteudo") }}
        
        {% if form.conteudo.errors %}
            <div class="text-danger">
                {% for error in form.conteudo.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
        
        <small class="form-text text-muted">
            üí° Use a barra de ferramentas acima para inserir multim√≠dia e formata√ß√£o
        </small>
    </div>

    <!-- Upload de Imagem R√°pido -->
    <div class="mb-3" id="imageUploadSection" style="display: none;">
        <div class="card">
            <div class="card-header">
                <strong>üì∑ Upload de Imagem para o Texto</strong>
            </div>
            <div class="card-body">
                <input type="file" id="textImageUpload" accept="image/*" class="form-control mb-2">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success btn-sm" onclick="uploadTextImage()">
                        ‚¨ÜÔ∏è Fazer Upload
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="hideImageUpload()">
                        ‚ùå Cancelar
                    </button>
                </div>
                <div id="uploadProgress" style="display: none;" class="mt-2">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-3">
        {{ form.imagem.label(class="form-label") }}
        {{ form.imagem(class="form-control") }}
        {% if editing and post and post.imagem %}
            <small class="form-text text-muted">
                Imagem atual: <a href="{{ post.imagem }}" target="_blank">Ver imagem</a>
            </small>
        {% endif %}
        {% if form.imagem.errors %}
            <div class="text-danger">
                {% for error in form.imagem.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
        <small class="form-text text-muted">Imagem de destaque do post</small>
    </div>

    <div class="mb-3 form-check">
        {{ form.publicado(class="form-check-input") }}
        {{ form.publicado.label(class="form-check-label") }}
    </div>

    <button type="submit" class="btn btn-primary btn-lg">
        {% if editing %}‚úèÔ∏è Atualizar Post{% else %}üìù Publicar Post{% endif %}
    </button>
    
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary ms-2">
        ‚Üê Voltar ao Painel
    </a>
    
    {% if editing %}
        <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
            üóëÔ∏è Deletar Post
        </button>
    {% endif %}
</form>

<!-- Preview ao vivo -->
<div class="mt-4">
    <div class="card">
        <div class="card-header">
            <strong>üëÄ Preview do Conte√∫do</strong>
            <button type="button" class="btn btn-sm btn-outline-primary float-end" onclick="togglePreview()">
                Atualizar Preview
            </button>
        </div>
        <div class="card-body" id="contentPreview">
            <em>Digite no editor acima para ver o preview...</em>
        </div>
    </div>
</div>

{% if editing %}
<!-- Modal de confirma√ß√£o para deletar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja deletar o post "{{ post.titulo }}"? Esta a√ß√£o n√£o pode ser desfeita.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('admin.deletar_post', post_id=post.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Deletar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.editor-toolbar {
    border-bottom: 1px solid #dee2e6;
}
.editor-toolbar .btn {
    margin: 2px;
}
#contentPreview {
    max-height: 300px;
    overflow-y: auto;
}
#contentPreview img {
    max-width: 100%;
    height: auto;
}
#contentPreview video {
    max-width: 100%;
    height: auto;
}
</style>

<script>
// Refer√™ncia ao textarea
const textarea = document.getElementById('conteudo');

// Atalhos de teclado
textarea.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        formatText('strong');
    }
    if (e.ctrlKey && e.key === 'i') {
        e.preventDefault();
        formatText('em');
    }
    if (e.ctrlKey && e.key === 'u') {
        e.preventDefault();
        formatText('u');
    }
});

// Formata√ß√£o de texto
function formatText(tag) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let newText;
    if (tag === 'h2') {
        newText = `<h2>${selectedText || 'Seu t√≠tulo aqui'}</h2>\n\n`;
    } else if (tag === 'h3') {
        newText = `<h3>${selectedText || 'Seu subt√≠tulo aqui'}</h3>\n\n`;
    } else if (tag === 'p') {
        newText = `<p>${selectedText || 'Seu par√°grafo aqui'}</p>\n\n`;
    } else if (tag === 'ul') {
        newText = `<ul>\n  <li>${selectedText || 'Item 1'}</li>\n  <li>Item 2</li>\n  <li>Item 3</li>\n</ul>\n\n`;
    } else {
        newText = `<${tag}>${selectedText || 'texto'}</${tag}>`;
    }
    
    insertTextAtCursor(newText);
}

// Inserir link
function insertLink() {
    const url = prompt('Digite a URL do link:');
    if (url) {
        const text = prompt('Texto do link:', url);
        const linkHTML = `<a href="${url}" target="_blank">${text || url}</a>`;
        insertTextAtCursor(linkHTML);
    }
}

// Inserir v√≠deo
function insertVideo() {
    const videoUrl = prompt('Cole a URL do v√≠deo (YouTube, Vimeo ou MP4):');
    if (videoUrl) {
        let videoHTML = '';
        
        if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
            const videoId = extractYouTubeId(videoUrl);
            videoHTML = `<div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                <iframe src="https://www.youtube.com/embed/${videoId}" 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                        frameborder="0" allowfullscreen></iframe>
            </div>\n\n`;
        } else if (videoUrl.includes('vimeo.com')) {
            const videoId = videoUrl.split('/').pop();
            videoHTML = `<div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                <iframe src="https://player.vimeo.com/video/${videoId}" 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                        frameborder="0" allowfullscreen></iframe>
            </div>\n\n`;
        } else {
            videoHTML = `<video controls style="max-width: 100%; height: auto;">
                <source src="${videoUrl}" type="video/mp4">
                Seu navegador n√£o suporta v√≠deo HTML5.
            </video>\n\n`;
        }
        
        insertTextAtCursor(videoHTML);
    }
}

// Extrair ID do YouTube
function extractYouTubeId(url) {
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : '';
}

// Mostrar upload de imagem
function showImageUpload() {
    document.getElementById('imageUploadSection').style.display = 'block';
}

// Esconder upload de imagem
function hideImageUpload() {
    document.getElementById('imageUploadSection').style.display = 'none';
}

// Upload de imagem para o texto
function uploadTextImage() {
    const fileInput = document.getElementById('textImageUpload');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Selecione uma imagem primeiro!');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Mostrar progresso
    const progressDiv = document.getElementById('uploadProgress');
    progressDiv.style.display = 'block';
    
    fetch('/admin/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const imageHTML = `<img src="${data.file_url}" alt="${data.filename}" style="max-width: 100%; height: auto;" class="img-fluid">\n\n`;
            insertTextAtCursor(imageHTML);
            hideImageUpload();
            fileInput.value = '';
        } else {
            alert('Erro no upload: ' + data.error);
        }
        progressDiv.style.display = 'none';
    })
    .catch(error => {
        alert('Erro no upload: ' + error);
        progressDiv.style.display = 'none';
    });
}

// Inserir linha horizontal
function insertHR() {
    insertTextAtCursor('<hr>\n\n');
}

// Inserir quebra de linha
function insertBreak() {
    insertTextAtCursor('<br>\n');
}

// Fun√ß√£o auxiliar para inserir texto no cursor
function insertTextAtCursor(text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    
    textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
    
    // Reposicionar cursor
    const newPos = start + text.length;
    textarea.selectionStart = newPos;
    textarea.selectionEnd = newPos;
    textarea.focus();
    
    // Atualizar preview
    togglePreview();
}

// Preview do conte√∫do
function togglePreview() {
    const content = textarea.value;
    const preview = document.getElementById('contentPreview');
    
    if (content.trim()) {
        preview.innerHTML = content;
    } else {
        preview.innerHTML = '<em>Digite no editor acima para ver o preview...</em>';
    }
}

// Atualizar preview automaticamente
textarea.addEventListener('input', togglePreview);

// Preview inicial
document.addEventListener('DOMContentLoaded', togglePreview);
</script>
{% endblock %}