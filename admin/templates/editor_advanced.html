<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Avan√ßado - Mente Magna</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- TinyMCE Editor -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    
    <style>
        .editor-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .attachment-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }
        
        .attachment-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .drag-drop-zone {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafafa;
        }
        
        .drag-drop-zone:hover,
        .drag-drop-zone.dragover {
            border-color: #0d6efd;
            background: #f0f8ff;
        }
        
        .progress-container {
            display: none;
            margin-top: 10px;
        }
        
        .editor-sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tag-input {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 8px;
            min-height: 38px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        
        .tag {
            background: #0d6efd;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            padding: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .attachment-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <span class="navbar-brand">üìù Editor Avan√ßado - Mente Magna</span>
        <div>
            <button class="btn btn-outline-light btn-sm me-2" onclick="saveAsDraft()">
                üíæ Salvar Rascunho
            </button>
            <button class="btn btn-success btn-sm me-2" onclick="publishPost()">
                üöÄ Publicar
            </button>
            <a href="/admin" class="btn btn-outline-light btn-sm">‚Üê Voltar</a>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Editor Principal -->
        <div class="col-lg-8">
            <form id="postForm" enctype="multipart/form-data">
                <!-- T√≠tulo -->
                <div class="editor-container">
                    <div class="mb-3">
                        <label class="form-label fw-bold">üìã T√≠tulo do Post</label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="titulo" 
                               name="titulo"
                               placeholder="Digite um t√≠tulo atrativo..."
                               maxlength="200"
                               required>
                        <div class="form-text">
                            <span id="tituloCount">0</span>/200 caracteres
                            <span id="slugPreview" class="ms-3 text-muted"></span>
                        </div>
                    </div>

                    <!-- Resumo -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">üìù Resumo (SEO)</label>
                        <textarea class="form-control" 
                                  id="resumo" 
                                  name="resumo"
                                  rows="3" 
                                  placeholder="Breve descri√ß√£o do post para SEO..."
                                  maxlength="160"></textarea>
                        <div class="form-text">
                            <span id="resumoCount">0</span>/160 caracteres (ideal para Google)
                        </div>
                    </div>
                </div>

                <!-- Editor de Conte√∫do -->
                <div class="editor-container">
                    <label class="form-label fw-bold">‚úçÔ∏è Conte√∫do do Post</label>
                    <textarea id="conteudo" name="conteudo"></textarea>
                </div>

                <!-- Anexos e M√≠dias -->
                <div class="editor-container">
                    <h5 class="fw-bold mb-3">üìé Anexos e M√≠dias</h5>
                    
                    <!-- Tabs para diferentes tipos de anexos -->
                    <ul class="nav nav-tabs" id="attachmentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-pane" type="button">
                                üñºÔ∏è Imagens
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button">
                                üé• V√≠deos
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-pane" type="button">
                                üîó URLs
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="attachmentTabContent">
                        <!-- Upload de Imagens -->
                        <div class="tab-pane fade show active" id="image-pane">
                            <div class="drag-drop-zone" id="imageDropZone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Arraste imagens aqui ou clique para selecionar</h5>
                                <p class="text-muted">Suporta: JPG, PNG, GIF, WebP (m√°x: 5MB)</p>
                                <input type="file" id="imageInput" multiple accept="image/*" class="d-none">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                                    üìÅ Selecionar Imagens
                                </button>
                            </div>
                            <div class="progress-container">
                                <div class="progress">
                                    <div class="progress-bar" id="imageProgress"></div>
                                </div>
                            </div>
                            <div id="imageAttachments" class="mt-3"></div>
                        </div>

                        <!-- V√≠deos -->
                        <div class="tab-pane fade" id="video-pane">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>üìπ Upload de V√≠deo</h6>
                                    <div class="drag-drop-zone" id="videoDropZone">
                                        <i class="fas fa-video fa-2x text-muted mb-2"></i>
                                        <p class="text-muted">Arraste v√≠deos aqui</p>
                                        <input type="file" id="videoInput" accept="video/*" class="d-none">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="document.getElementById('videoInput').click()">
                                            üìπ Selecionar V√≠deo
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>üîó URL de V√≠deo</h6>
                                    <div class="mb-3">
                                        <input type="url" class="form-control" id="videoUrl" placeholder="https://youtube.com/watch?v=...">
                                    </div>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="videoTitle" placeholder="T√≠tulo do v√≠deo (opcional)">
                                    </div>
                                    <button type="button" class="btn btn-success" onclick="addVideoUrl()">
                                        ‚ûï Adicionar V√≠deo
                                    </button>
                                </div>
                            </div>
                            <div id="videoAttachments" class="mt-3"></div>
                        </div>

                        <!-- URLs -->
                        <div class="tab-pane fade" id="url-pane">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="url" class="form-control" id="urlInput" placeholder="https://exemplo.com">
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-info w-100" onclick="addUrl()">
                                        ‚ûï Adicionar URL
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3">
                                <input type="text" class="form-control" id="urlTitle" placeholder="T√≠tulo/descri√ß√£o da URL (opcional)">
                            </div>
                            <div id="urlAttachments" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√µes do Post -->
                <div class="editor-container">
                    <h5 class="fw-bold mb-3">‚öôÔ∏è Configura√ß√µes</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üè∑Ô∏è Tags (SEO)</label>
                                <div class="tag-input" id="tagInput">
                                    <input type="text" class="form-control border-0 flex-grow-1" 
                                           placeholder="Digite uma tag e pressione Enter"
                                           id="tagField">
                                </div>
                                <input type="hidden" id="keywords" name="keywords">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">üì∏ Imagem de Destaque</label>
                                <input type="file" class="form-control" id="featuredImage" accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="publicado" name="publicado">
                                <label class="form-check-label" for="publicado">
                                    üì¢ Publicar imediatamente
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="featured">
                                <label class="form-check-label" for="featured">
                                    ‚≠ê Post em destaque
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="allowComments">
                                <label class="form-check-label" for="allowComments">
                                    üí¨ Permitir coment√°rios
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="editor-container text-center">
                    <button type="button" class="btn btn-success btn-lg me-3" onclick="publishPost()">
                        üöÄ Publicar Post
                    </button>
                    <button type="button" class="btn btn-outline-primary me-3" onclick="saveAsDraft()">
                        üíæ Salvar Rascunho
                    </button>
                    <button type="button" class="btn btn-outline-secondary me-3" onclick="previewPost()">
                        üëÅÔ∏è Visualizar
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="discardChanges()">
                        üóëÔ∏è Descartar
                    </button>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Estat√≠sticas em Tempo Real -->
            <div class="stats-card">
                <h6 class="fw-bold mb-3">üìä Estat√≠sticas do Post</h6>
                <div class="row text-center">
                    <div class="col-4">
                        <h4 id="wordCount">0</h4>
                        <small>Palavras</small>
                    </div>
                    <div class="col-4">
                        <h4 id="readingTime">0</h4>
                        <small>Min leitura</small>
                    </div>
                    <div class="col-4">
                        <h4 id="seoScore">0%</h4>
                        <small>SEO Score</small>
                    </div>
                </div>
            </div>

            <!-- Preview em Tempo Real -->
            <div class="editor-sidebar">
                <h6 class="fw-bold mb-3">üëÅÔ∏è Preview</h6>
                <div id="livePreview">
                    <h6 id="previewTitle" class="text-muted">T√≠tulo aparecer√° aqui...</h6>
                    <div id="previewContent" class="text-muted mt-2">
                        Conte√∫do aparecer√° aqui...
                    </div>
                </div>
            </div>

            <!-- Dicas de SEO -->
            <div class="editor-sidebar">
                <h6 class="fw-bold mb-3">üí° Dicas de SEO</h6>
                <ul class="list-unstyled">
                    <li id="seoTitleTip" class="mb-2">
                        <i class="fas fa-circle text-secondary"></i>
                        <small>T√≠tulo entre 50-60 caracteres</small>
                    </li>
                    <li id="seoDescTip" class="mb-2">
                        <i class="fas fa-circle text-secondary"></i>
                        <small>Meta descri√ß√£o at√© 160 caracteres</small>
                    </li>
                    <li id="seoContentTip" class="mb-2">
                        <i class="fas fa-circle text-secondary"></i>
                        <small>M√≠nimo 300 palavras</small>
                    </li>
                    <li id="seoImageTip" class="mb-2">
                        <i class="fas fa-circle text-secondary"></i>
                        <small>Pelo menos uma imagem</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Preview -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üëÅÔ∏è Preview do Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="fullPreviewContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Inicializar TinyMCE
tinymce.init({
    selector: '#conteudo',
    height: 500,
    language: 'pt_BR',
    plugins: [
        'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
        'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
        'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
    ],
    toolbar: 'undo redo | blocks | bold italic underline strikethrough | ' +
             'alignleft aligncenter alignright alignjustify | ' +
             'bullist numlist outdent indent | ' +
             'link image media | ' +
             'forecolor backcolor | ' +
             'emoticons charmap | ' +
             'preview code fullscreen | help',
    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 16px; }',
    image_advtab: true,
    image_caption: true,
    quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote',
    contextmenu: 'link image table',
    setup: function(editor) {
        editor.on('input change', function() {
            updateStats();
            updatePreview();
        });
    }
});

// Vari√°veis globais
let attachments = {
    images: [],
    videos: [],
    urls: []
};
let tags = [];

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    updateStats();
});

function setupEventListeners() {
    // T√≠tulo
    document.getElementById('titulo').addEventListener('input', function() {
        updateStats();
        updatePreview();
        updateSlugPreview();
    });

    // Resumo
    document.getElementById('resumo').addEventListener('input', function() {
        updateStats();
    });

    // Tags
    document.getElementById('tagField').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
            e.preventDefault();
            addTag(this.value.trim());
            this.value = '';
        }
    });

    // Drag and Drop para imagens
    setupDragAndDrop();
}

function updateStats() {
    const titulo = document.getElementById('titulo').value;
    const resumo = document.getElementById('resumo').value;
    const conteudo = tinymce.get('conteudo') ? tinymce.get('conteudo').getContent({format: 'text'}) : '';

    // Contadores
    document.getElementById('tituloCount').textContent = titulo.length;
    document.getElementById('resumoCount').textContent = resumo.length;

    // Palavras e tempo de leitura
    const words = conteudo.trim() ? conteudo.trim().split(/\s+/).length : 0;
    const readingMinutes = Math.max(1, Math.ceil(words / 200));

    document.getElementById('wordCount').textContent = words;
    document.getElementById('readingTime').textContent = readingMinutes;

    // SEO Score
    updateSEOScore(titulo, resumo, conteudo, words);
}

function updateSEOScore(titulo, resumo, conteudo, words) {
    let score = 0;
    const tips = {
        title: document.getElementById('seoTitleTip'),
        desc: document.getElementById('seoDescTip'),
        content: document.getElementById('seoContentTip'),
        image: document.getElementById('seoImageTip')
    };

    // T√≠tulo (25 pontos)
    if (titulo.length >= 50 && titulo.length <= 60) {
        score += 25;
        updateTipStatus(tips.title, 'success');
    } else {
        updateTipStatus(tips.title, 'warning');
    }

    // Meta descri√ß√£o (25 pontos)
    if (resumo.length >= 120 && resumo.length <= 160) {
        score += 25;
        updateTipStatus(tips.desc, 'success');
    } else {
        updateTipStatus(tips.desc, 'warning');
    }

    // Conte√∫do (25 pontos)
    if (words >= 300) {
        score += 25;
        updateTipStatus(tips.content, 'success');
    } else {
        updateTipStatus(tips.content, 'warning');
    }

    // Imagem (25 pontos)
    if (attachments.images.length > 0 || conteudo.includes('<img')) {
        score += 25;
        updateTipStatus(tips.image, 'success');
    } else {
        updateTipStatus(tips.image, 'warning');
    }

    document.getElementById('seoScore').textContent = score + '%';
}

function updateTipStatus(element, status) {
    const icon = element.querySelector('i');
    icon.className = 'fas fa-circle text-' + (status === 'success' ? 'success' : 'warning');
}

function updatePreview() {
    const titulo = document.getElementById('titulo').value || 'T√≠tulo do post...';
    const conteudo = tinymce.get('conteudo') ? tinymce.get('conteudo').getContent() : 'Conte√∫do do post...';

    document.getElementById('previewTitle').textContent = titulo;
    document.getElementById('previewContent').innerHTML = conteudo.substring(0, 300) + '...';
}

function updateSlugPreview() {
    const titulo = document.getElementById('titulo').value;
    if (titulo) {
        const slug = titulo.toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .substring(0, 50);
        document.getElementById('slugPreview').textContent = `URL: /blog/${slug}`;
    }
}

// Tags
function addTag(tagText) {
    if (!tags.includes(tagText) && tags.length < 10) {
        tags.push(tagText);
        updateTagsDisplay();
        updateKeywordsInput();
    }
}

function removeTag(tagText) {
    tags = tags.filter(tag => tag !== tagText);
    updateTagsDisplay();
    updateKeywordsInput();
}

function updateTagsDisplay() {
    const container = document.getElementById('tagInput');
    const input = container.querySelector('input');
    
    // Remove tags existentes
    container.querySelectorAll('.tag').forEach(tag => tag.remove());
    
    // Adiciona tags atuais
    tags.forEach(tagText => {
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.innerHTML = `
            ${tagText}
            <button type="button" class="tag-remove" onclick="removeTag('${tagText}')">√ó</button>
        `;
        container.insertBefore(tag, input);
    });
}

function updateKeywordsInput() {
    document.getElementById('keywords').value = tags.join(', ');
}

// Drag and Drop
function setupDragAndDrop() {
    const imageZone = document.getElementById('imageDropZone');
    const videoZone = document.getElementById('videoDropZone');

    [imageZone, videoZone].forEach(zone => {
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        zone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        zone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                if (zone.id === 'imageDropZone') {
                    handleImageUpload(files);
                } else {
                    handleVideoUpload(files[0]);
                }
            }
        });
    });

    // Click handlers
    imageZone.addEventListener('click', () => document.getElementById('imageInput').click());
    videoZone.addEventListener('click', () => document.getElementById('videoInput').click());

    // File input handlers
    document.getElementById('imageInput').addEventListener('change', function(e) {
        handleImageUpload(e.target.files);
    });

    document.getElementById('videoInput').addEventListener('change', function(e) {
        handleVideoUpload(e.target.files[0]);
    });
}

// Upload handlers
async function handleImageUpload(files) {
    const progressContainer = document.querySelector('.progress-container');
    const progressBar = document.getElementById('imageProgress');
    
    progressContainer.style.display = 'block';
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        if (!file.type.startsWith('image/')) continue;
        if (file.size > 5 * 1024 * 1024) {
            alert(`Arquivo ${file.name} muito grande (m√°x: 5MB)`);
            continue;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            progressBar.style.width = '0%';
            
            const response = await fetch('/admin/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (result.success) {
                const attachment = {
                    id: Date.now() + i,
                    url: result.file_url,
                    filename: result.filename,
                    type: 'image',
                    size: result.file_size
                };
                
                attachments.images.push(attachment);
                addImageAttachment(attachment);
                
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 1000);
            } else {
                alert(`Erro no upload: ${result.error}`);
            }
        } catch (error) {
            alert(`Erro no upload: ${error.message}`);
        }
    }
    
    setTimeout(() => {
        progressContainer.style.display = 'none';
    }, 2000);
}

function addImageAttachment(attachment) {
    const container = document.getElementById('imageAttachments');
    const div = document.createElement('div');
    div.className = 'attachment-item';
    div.dataset.id = attachment.id;
    
    div.innerHTML = `
        <div class="row align-items-center">
            <div class="col-auto">
                <img src="${attachment.url}" class="attachment-preview" alt="Preview">
            </div>
            <div class="col">
                <h6 class="mb-1">${attachment.filename}</h6>
                <small class="text-muted">${(attachment.size / 1024).toFixed(1)} KB</small>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-outline-primary me-2" 
                        onclick="insertIntoEditor('${attachment.url}', 'image')">
                    üìù Inserir no Post
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeAttachment('images', ${attachment.id})">
                    üóëÔ∏è Remover
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(div);
}

async function handleVideoUpload(file) {
    if (!file.type.startsWith('video/')) {
        alert('Arquivo deve ser um v√≠deo');
        return;
    }
    
    if (file.size > 50 * 1024 * 1024) {
        alert('V√≠deo muito grande (m√°x: 50MB)');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/admin/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        
        if (result.success) {
            const attachment = {
                id: Date.now(),
                url: result.file_url,
                filename: result.filename,
                type: 'video',
                size: result.file_size
            };
            
            attachments.videos.push(attachment);
            addVideoAttachment(attachment);
        } else {
            alert(`Erro no upload: ${result.error}`);
        }
    } catch (error) {
        alert(`Erro no upload: ${error.message}`);
    }
}

function addVideoUrl() {
    const url = document.getElementById('videoUrl').value;
    const title = document.getElementById('videoTitle').value;
    
    if (!url) {
        alert('Por favor, insira uma URL de v√≠deo');
        return;
    }

    const attachment = {
        id: Date.now(),
        url: url,
        title: title || 'V√≠deo',
        type: 'video-url'
    };
    
    attachments.videos.push(attachment);
    addVideoAttachment(attachment);
    
    document.getElementById('videoUrl').value = '';
    document.getElementById('videoTitle').value = '';
}

function addVideoAttachment(attachment) {
    const container = document.getElementById('videoAttachments');
    const div = document.createElement('div');
    div.className = 'attachment-item';
    div.dataset.id = attachment.id;
    
    const isYouTube = attachment.url.includes('youtube.com') || attachment.url.includes('youtu.be');
    const previewContent = isYouTube ? 
        `<iframe width="120" height="80" src="${getYouTubeEmbedUrl(attachment.url)}" frameborder="0"></iframe>` :
        `<video width="120" height="80" controls><source src="${attachment.url}"></video>`;
    
    div.innerHTML = `
        <div class="row align-items-center">
            <div class="col-auto">
                ${previewContent}
            </div>
            <div class="col">
                <h6 class="mb-1">${attachment.title || attachment.filename}</h6>
                <small class="text-muted">${attachment.type}</small>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-outline-primary me-2" 
                        onclick="insertIntoEditor('${attachment.url}', 'video')">
                    üìù Inserir no Post
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeAttachment('videos', ${attachment.id})">
                    üóëÔ∏è Remover
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(div);
}

function addUrl() {
    const url = document.getElementById('urlInput').value;
    const title = document.getElementById('urlTitle').value;
    
    if (!url) {
        alert('Por favor, insira uma URL');
        return;
    }

    const attachment = {
        id: Date.now(),
        url: url,
        title: title || url,
        type: 'url'
    };
    
    attachments.urls.push(attachment);
    addUrlAttachment(attachment);
    
    document.getElementById('urlInput').value = '';
    document.getElementById('urlTitle').value = '';
}

function addUrlAttachment(attachment) {
    const container = document.getElementById('urlAttachments');
    const div = document.createElement('div');
    div.className = 'attachment-item';
    div.dataset.id = attachment.id;
    
    div.innerHTML = `
        <div class="row align-items-center">
            <div class="col-auto">
                <i class="fas fa-link fa-2x text-primary"></i>
            </div>
            <div class="col">
                <h6 class="mb-1">${attachment.title}</h6>
                <small class="text-muted">${attachment.url}</small>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-outline-primary me-2" 
                        onclick="insertIntoEditor('${attachment.url}', 'link', '${attachment.title}')">
                    üìù Inserir no Post
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeAttachment('urls', ${attachment.id})">
                    üóëÔ∏è Remover
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(div);
}

function removeAttachment(type, id) {
    attachments[type] = attachments[type].filter(att => att.id !== id);
    document.querySelector(`[data-id="${id}"]`).remove();
}

function insertIntoEditor(url, type, title = '') {
    const editor = tinymce.get('conteudo');
    let content = '';
    
    switch (type) {
        case 'image':
            content = `<img src="${url}" alt="Imagem" style="max-width: 100%; height: auto;" />`;
            break;
        case 'video':
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const embedUrl = getYouTubeEmbedUrl(url);
                content = `<iframe width="560" height="315" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
            } else {
                content = `<video controls style="max-width: 100%;"><source src="${url}" type="video/mp4">Seu navegador n√£o suporta v√≠deo.</video>`;
            }
            break;
        case 'link':
            content = `<a href="${url}" target="_blank">${title || url}</a>`;
            break;
    }
    
    editor.insertContent(content);
}

function getYouTubeEmbedUrl(url) {
    const videoId = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
    return videoId ? `https://www.youtube.com/embed/${videoId[1]}` : url;
}

// A√ß√µes principais
async function saveAsDraft() {
    document.getElementById('publicado').checked = false;
    await savePost();
}

async function publishPost() {
    document.getElementById('publicado').checked = true;
    await savePost();
}

async function savePost() {
    const formData = new FormData();
    
    // Dados b√°sicos
    formData.append('titulo', document.getElementById('titulo').value);
    formData.append('resumo', document.getElementById('resumo').value);
    formData.append('conteudo', tinymce.get('conteudo').getContent());
    formData.append('keywords', document.getElementById('keywords').value);
    formData.append('publicado', document.getElementById('publicado').checked);
    formData.append('featured', document.getElementById('featured').checked);
    
    // Anexos
    formData.append('attachments', JSON.stringify(attachments));
    
    // Imagem de destaque
    const featuredImage = document.getElementById('featuredImage').files[0];
    if (featuredImage) {
        formData.append('featured_image', featuredImage);
    }

    try {
        const response = await fetch('/admin/novo', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        
        if (result.success) {
            alert('Post salvo com sucesso!');
            window.location.href = '/admin';
        } else {
            alert(`Erro ao salvar: ${result.error}`);
        }
    } catch (error) {
        alert(`Erro ao salvar: ${error.message}`);
    }
}

function previewPost() {
    const titulo = document.getElementById('titulo').value;
    const conteudo = tinymce.get('conteudo').getContent();
    
    document.getElementById('fullPreviewContent').innerHTML = `
        <h1>${titulo}</h1>
        <div class="mt-3">${conteudo}</div>
    `;
    
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function discardChanges() {
    if (confirm('Tem certeza que deseja descartar todas as altera√ß√µes?')) {
        window.location.href = '/admin';
    }
}

// Auto-save a cada 30 segundos
setInterval(function() {
    const titulo = document.getElementById('titulo').value;
    const conteudo = tinymce.get('conteudo') ? tinymce.get('conteudo').getContent() : '';
    
    if (titulo && conteudo) {
        localStorage.setItem('draft_post', JSON.stringify({
            titulo,
            resumo: document.getElementById('resumo').value,
            conteudo,
            tags,
            attachments,
            timestamp: new Date().toISOString()
        }));
    }
}, 30000);

// Carregar rascunho se existir
window.addEventListener('load', function() {
    const draft = localStorage.getItem('draft_post');
    if (draft) {
        const data = JSON.parse(draft);
        const lastSaved = new Date(data.timestamp);
        const now = new Date();
        
        if ((now - lastSaved) < 24 * 60 * 60 * 1000) { // 24 horas
            if (confirm('Encontramos um rascunho salvo. Deseja carreg√°-lo?')) {
                document.getElementById('titulo').value = data.titulo;
                document.getElementById('resumo').value = data.resumo;
                
                if (tinymce.get('conteudo')) {
                    tinymce.get('conteudo').setContent(data.conteudo);
                }
                
                tags = data.tags || [];
                attachments = data.attachments || {images: [], videos: [], urls: []};
                
                updateTagsDisplay();
                updateStats();
            }
        }
    }
});
</script>

</body>
</html>