{% extends 'base.html' %}

{% set page_title = post.titulo + ' - Mente Magna' %}
{% set page_description = post.resumo or (post.conteudo|striptags)[:160] %}
{% set page_keywords = 'tecnologia, programa√ß√£o, ' + post.titulo %}

{% block og_type %}article{% endblock %}
{% block og_title %}{{ post.titulo }}{% endblock %}
{% block og_description %}{{ post.resumo or (post.conteudo|striptags)[:160] }}{% endblock %}
{% block og_image %}{{ post.imagem or url_for('static', filename='img/logo_mentemagna.png', _external=True) }}{% endblock %}

{% block schema_type %}Article{% endblock %}
{% block schema_extra %},
    "headline": "{{ post.titulo }}",
    "datePublished": "{{ post.data_criacao.isoformat() }}",
    "dateModified": "{{ post.data_criacao.isoformat() }}",
    "author": {
      "@type": "Person",
      "name": "Mente Magna"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Mente Magna",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ url_for('static', filename='img/logo_mentemagna.png', _external=True) }}"
      }
    },
    "image": "{{ post.imagem or url_for('static', filename='img/logo_mentemagna.png', _external=True) }}",
    "articleBody": "{{ (post.conteudo|striptags)[:500] }}"{% endblock %}

{% block content %}
<div class="row">
    <!-- Conte√∫do Principal do Post -->
    <div class="col-lg-8">
        <article class="mb-5">
            <!-- Cabe√ßalho do Post -->
            <div class="mb-4">
                <h1 class="display-5 fw-bold">{{ post.titulo }}</h1>
                <div class="text-muted mb-3">
                    <small>
                        üìÖ {{ post.data_criacao.strftime('%d/%m/%Y √†s %H:%M') }} | 
                        üë§ <strong>Mente Magna</strong> | 
                        üè∑Ô∏è <span class="badge bg-primary">Tecnologia</span> |
                        üëÅÔ∏è <span id="viewCount">Carregando...</span> visualiza√ß√µes
                    </small>
                </div>
                
                {% if post.imagem %}
                    <img src="{{ post.imagem }}" 
                         class="img-fluid rounded shadow mb-4" 
                         alt="{{ post.titulo }}"
                         loading="lazy">
                {% endif %}
            </div>

            <!-- AN√öNCIO MOBILE BANNER (s√≥ aparece em mobile) -->
            <div class="d-block d-lg-none mb-4">
                <div class="ad-container">
                    <div class="ad-label">Publicidade</div>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-4115727278051485"
                         data-ad-slot="7777777777"
                         data-ad-format="banner"
                         data-full-width-responsive="true"></ins>
                    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                </div>
            </div>

            <!-- Conte√∫do do Post com An√∫ncio In-Content -->
            <div class="post-content">
                {% set content_parts = post.conteudo.split('</p>') %}
                
                <!-- Primeiro par√°grafo -->
                {% if content_parts|length > 0 %}
                    {{ content_parts[0] }}</p>
                {% endif %}
                
                <!-- AN√öNCIO IN-CONTENT ap√≥s primeiro par√°grafo (MELHOR CTR) -->
                {% if content_parts|length > 1 %}
                    <div class="my-4">
                        <div class="ad-container">
                            <div class="ad-label">Publicidade</div>
                            <ins class="adsbygoogle"
                                 style="display:block; text-align:center;"
                                 data-ad-layout="in-article"
                                 data-ad-format="fluid"
                                 data-ad-client="ca-pub-4115727278051485"
                                 data-ad-slot="9876543210"></ins>
                            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Resto do conte√∫do -->
                {% for part in content_parts[1:] %}
                    {% if part.strip() %}
                        {{ part }}</p>
                        
                        <!-- An√∫ncio adicional no meio do conte√∫do (se artigo for longo) -->
                        {% if loop.index == (content_parts|length // 2) and content_parts|length > 6 %}
                            <div class="my-4">
                                <div class="ad-container">
                                    <div class="ad-label">Publicidade</div>
                                    <ins class="adsbygoogle"
                                         style="display:block"
                                         data-ad-client="ca-pub-4115727278051485"
                                         data-ad-slot="3333333333"
                                         data-ad-format="rectangle"
                                         data-full-width-responsive="true"></ins>
                                    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>

            <!-- AN√öNCIO FINAL DO ARTIGO (ALTA PERFORMANCE) -->
            <div class="my-5">
                <div class="ad-container">
                    <div class="ad-label">Publicidade</div>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-4115727278051485"
                         data-ad-slot="2222222222"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                </div>
            </div>

            <!-- Navega√ß√£o Entre Posts -->
            <div class="row mt-5">
                <div class="col-md-6">
                    {% if previous_post %}
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">‚Üê Post Anterior</h6>
                                <h5 class="card-title">
                                    <a href="{{ url_for('blog.post_detail', slug=previous_post.slug) }}" 
                                       class="text-decoration-none">
                                        {{ previous_post.titulo }}
                                    </a>
                                </h5>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if next_post %}
                        <div class="card h-100">
                            <div class="card-body text-end">
                                <h6 class="card-subtitle mb-2 text-muted">Pr√≥ximo Post ‚Üí</h6>
                                <h5 class="card-title">
                                    <a href="{{ url_for('blog.post_detail', slug=next_post.slug) }}" 
                                       class="text-decoration-none">
                                        {{ next_post.titulo }}
                                    </a>
                                </h5>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Compartilhamento Social -->
            <div class="mt-4 p-3 bg-light rounded">
                <h6 class="mb-3">üì¢ Compartilhe este artigo:</h6>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" 
                       target="_blank" 
                       class="btn btn-primary btn-sm"
                       onclick="trackSocialShare('Facebook')">
                        üìò Facebook
                    </a>
                    <a href="https://twitter.com/intent/tweet?url={{ request.url }}&text={{ post.titulo }}" 
                       target="_blank" 
                       class="btn btn-info btn-sm"
                       onclick="trackSocialShare('Twitter')">
                        üê¶ Twitter
                    </a>
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url }}" 
                       target="_blank" 
                       class="btn btn-secondary btn-sm"
                       onclick="trackSocialShare('LinkedIn')">
                        üíº LinkedIn
                    </a>
                    <a href="whatsapp://send?text={{ post.titulo }} {{ request.url }}" 
                       class="btn btn-success btn-sm"
                       onclick="trackSocialShare('WhatsApp')">
                        üí¨ WhatsApp
                    </a>
                    <button type="button" 
                            class="btn btn-outline-secondary btn-sm" 
                            onclick="copyToClipboard('{{ request.url }}')">
                        üìã Copiar Link
                    </button>
                </div>
            </div>

            <!-- Se√ß√£o de Coment√°rios (placeholder para futuro) -->
            <div class="mt-5 p-4 bg-light rounded">
                <h5>üí¨ Coment√°rios</h5>
                <p class="text-muted">
                    Em breve teremos um sistema de coment√°rios! 
                    Por enquanto, entre em contato conosco atrav√©s do 
                    <a href="{{ url_for('main.contato') }}" class="text-primary">formul√°rio de contato</a>.
                </p>
            </div>
        </article>
    </div>

    <!-- Sidebar Direita -->
    <aside class="col-lg-4">
        <!-- AN√öNCIO SIDEBAR PRINCIPAL (BONS RENDIMENTOS) -->
        <div class="sidebar-ad card mb-4">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0 text-muted">Publicidade</h6>
            </div>
            <div class="card-body text-center p-2">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-4115727278051485"
                     data-ad-slot="5555555555"
                     data-ad-format="rectangle"
                     data-full-width-responsive="true"></ins>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
        </div>

        <!-- √öltimos Artigos -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">üìö √öltimos Artigos</h5>
            </div>
            <div class="card-body">
                {% if recent_posts %}
                    {% for recent_post in recent_posts %}
                        {% if recent_post.id != post.id %}
                            <div class="d-flex mb-3 {% if not loop.last %}border-bottom pb-3{% endif %}">
                                {% if recent_post.imagem %}
                                    <img src="{{ recent_post.imagem }}" 
                                         class="me-3 rounded" 
                                         style="width: 80px; height: 60px; object-fit: cover;" 
                                         alt="{{ recent_post.titulo }}"
                                         loading="lazy">
                                {% else %}
                                    <div class="me-3 bg-light rounded d-flex align-items-center justify-content-center" 
                                         style="width: 80px; height: 60px; min-width: 80px;">
                                        <span class="text-muted">üìÑ</span>
                                    </div>
                                {% endif %}
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <a href="{{ url_for('blog.post_detail', slug=recent_post.slug) }}" 
                                           class="text-decoration-none text-dark">
                                            {{ recent_post.titulo|truncate(60) }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">
                                        üìÖ {{ recent_post.data_criacao.strftime('%d/%m/%Y') }}
                                    </small>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    <div class="text-center mt-3">
                        <a href="{{ url_for('blog.blog') }}" class="btn btn-outline-primary btn-sm">
                            üìñ Ver Todos os Artigos
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Nenhum artigo encontrado.</p>
                {% endif %}
            </div>
        </div>

        <!-- AN√öNCIO SIDEBAR SECUND√ÅRIO -->
        <div class="sidebar-ad card mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">Recomendado</h6>
            </div>
            <div class="card-body text-center p-2">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-4115727278051485"
                     data-ad-slot="6666666666"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
        </div>

        <!-- Newsletter/Contato -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">üìß Fique por Dentro</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Receba as √∫ltimas novidades em tecnologia e inova√ß√£o diretamente no seu email!</p>
                <a href="{{ url_for('main.contato') }}" class="btn btn-success btn-sm w-100">
                    ‚úâÔ∏è Entre em Contato
                </a>
            </div>
        </div>

        <!-- Tags/Categorias -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">üè∑Ô∏è Tags Populares</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-primary">Tecnologia</span>
                    <span class="badge bg-secondary">IA</span>
                    <span class="badge bg-success">Programa√ß√£o</span>
                    <span class="badge bg-danger">ChatGPT</span>
                    <span class="badge bg-warning text-dark">Python</span>
                    <span class="badge bg-info">Web Design</span>
                    <span class="badge bg-dark">Flask</span>
                    <span class="badge bg-primary">Machine Learning</span>
                </div>
            </div>
        </div>

        <!-- Sobre -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">‚ÑπÔ∏è Sobre o Mente Magna</h5>
            </div>
            <div class="card-body">
                <p class="card-text small">
                    Seu portal de refer√™ncia em tecnologia, inova√ß√£o e desenvolvimento. 
                    Compartilhamos conhecimento, insights e solu√ß√µes para o mundo digital.
                </p>
                <a href="{{ url_for('main.sobre') }}" class="btn btn-outline-dark btn-sm">
                    üìñ Saiba Mais
                </a>
            </div>
        </div>
    </aside>
</div>

<style>
/* Estilos espec√≠ficos para posts */
.post-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #333;
}

.post-content h2, .post-content h3 {
    color: #2c3e50;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.post-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin: 1.5rem 0;
}

.post-content blockquote {
    border-left: 4px solid #007bff;
    margin: 1.5rem 0;
    padding: 1rem 1.5rem;
    background-color: #f8f9fa;
    font-style: italic;
}

.post-content code {
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

.post-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
}

/* Melhorar apar√™ncia dos cards */
.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Responsividade para mobile */
@media (max-width: 768px) {
    .post-content {
        font-size: 1rem;
    }
    
    .display-5 {
        font-size: 2rem;
    }
    
    .ad-container {
        margin: 10px 0;
        padding: 8px;
    }
}

/* Anima√ß√£o para compartilhamento */
.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Estilo para copy feedback */
.copy-feedback {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #28a745;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    z-index: 9999;
    display: none;
}
</style>

<!-- Feedback visual para copy -->
<div id="copyFeedback" class="copy-feedback">
    ‚úÖ Link copiado!
</div>
{% endblock %}

{% block scripts %}
<script>
// Contador de visualiza√ß√µes simples
document.addEventListener('DOMContentLoaded', function() {
    // Simular contador de views (voc√™ pode implementar com backend)
    const viewCount = Math.floor(Math.random() * 1000) + 100;
    document.getElementById('viewCount').textContent = viewCount;
    
    // Tracking de tempo de leitura
    let startTime = Date.now();
    let maxScroll = 0;
    
    // Track scroll depth
    window.addEventListener('scroll', function() {
        const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
        maxScroll = Math.max(maxScroll, scrollPercent);
    });
    
    // Enviar analytics quando usu√°rio sair
    window.addEventListener('beforeunload', function() {
        const timeSpent = Math.round((Date.now() - startTime) / 1000);
        
        if (typeof gtag !== 'undefined') {
            gtag('event', 'page_view_time', {
                'event_category': 'engagement',
                'event_label': '{{ post.titulo }}',
                'value': timeSpent
            });
            
            gtag('event', 'scroll_depth', {
                'event_category': 'engagement',
                'event_label': '{{ post.titulo }}',
                'value': maxScroll
            });
        }
    });
});

// Fun√ß√£o para copiar link
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Mostrar feedback visual
        const feedback = document.getElementById('copyFeedback');
        feedback.style.display = 'block';
        
        setTimeout(function() {
            feedback.style.display = 'none';
        }, 2000);
        
        // Analytics
        if (typeof gtag !== 'undefined') {
            gtag('event', 'share', {
                'method': 'copy_link',
                'content_type': 'article',
                'content_id': '{{ post.slug }}'
            });
        }
    }).catch(function(err) {
        console.error('Erro ao copiar: ', err);
        // Fallback para navegadores antigos
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const feedback = document.getElementById('copyFeedback');
        feedback.style.display = 'block';
        setTimeout(() => feedback.style.display = 'none', 2000);
    });
}

// Tracking de compartilhamento social
function trackSocialShare(platform) {
    if (typeof gtag !== 'undefined') {
        gtag('event', 'share', {
            'method': platform.toLowerCase(),
            'content_type': 'article',
            'content_id': '{{ post.slug }}'
        });
    }
}

// Lazy loading melhorado para an√∫ncios
let adsInitialized = false;

function initializeAds() {
    if (!adsInitialized) {
        adsInitialized = true;
        
        // Verificar se cookies de publicidade est√£o aceitos
        const consent = localStorage.getItem('cookieConsent');
        const preferences = JSON.parse(localStorage.getItem('cookiePreferences') || '{}');
        
        if (consent === 'accepted' || (consent === 'customized' && preferences.advertising)) {
            // Carregar todos os an√∫ncios
            const ads = document.querySelectorAll('.adsbygoogle');
            ads.forEach(function(ad) {
                if (!ad.getAttribute('data-adsbygoogle-status')) {
                    try {
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    } catch (e) {
                        console.log('AdSense n√£o carregou ainda');
                    }
                }
            });
        }
    }
}

// Inicializar an√∫ncios quando usu√°rio fizer scroll
let scrollTimeout;
window.addEventListener('scroll', function() {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
        if (window.scrollY > 200) {
            initializeAds();
        }
    }, 100);
});

// Inicializar an√∫ncios ap√≥s 3 segundos se usu√°rio n√£o fez scroll
setTimeout(function() {
    initializeAds();
}, 3000);

// Melhorar performance: lazy load de imagens
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img[loading="lazy"]');
    
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver(function(entries, observer) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    img.classList.add('loaded');
                    observer.unobserve(img);
                }
            });
        });
        
        images.forEach(function(img) {
            imageObserver.observe(img);
        });
    }
});

// Auto-resize para an√∫ncios responsivos
window.addEventListener('resize', function() {
    // For√ßa rec√°lculo de an√∫ncios responsivos
    if (typeof adsbygoogle !== 'undefined') {
        try {
            const ads = document.querySelectorAll('.adsbygoogle');
            ads.forEach(function(ad) {
                if (ad.getAttribute('data-adsbygoogle-status') === 'done') {
                    // Re-renderizar an√∫ncio se necess√°rio
                    const rect = ad.getBoundingClientRect();
                    if (rect.height === 0) {
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    }
                }
            });
        } catch (e) {
            console.log('Erro ao re-renderizar an√∫ncios:', e);
        }
    }
});

// Prevenir cliques acidentais em an√∫ncios
document.querySelectorAll('.adsbygoogle').forEach(function(ad) {
    ad.addEventListener('click', function(e) {
        // Log para analytics (opcional)
        if (typeof gtag !== 'undefined') {
            gtag('event', 'ad_click', {
                'event_category': 'monetization',
                'event_label': 'adsense',
                'value': 1
            });
        }
    });
});
</script>
{% endblock %}